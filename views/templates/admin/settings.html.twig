{% extends '@PrestaShop/Admin/layout.html.twig' %}
{% import '@PrestaShop/Admin/macros.html.twig' as ps %}

{% block content %}
    {{ form_start(authenticateFormView) }}
    <div class="card">
        <h3 class="card-header">
            <i class="material-icons">lock</i> {{ 'Authentication'|trans({}, 'Modules.Sendynl.Admin') }}
        </h3>
        <div class="card-body">
            <div class="form-wrapper">
                {{ form_widget(authenticateFormView) }}
            </div>
        </div>
    </div>
    {{ form_end(authenticateFormView) }}

    {% if shouldDisplaySettingsForm %}
        {{ form_start(settingsFormView) }}
        <div class="card">
            <h3 class="card-header">
                <i class="material-icons">settings</i> {{ 'Settings'|trans({}, 'Modules.Sendynl.Admin') }}
            </h3>
            <div class="card-body">
                <div class="form-wrapper">
                    {{ form_row(settingsFormView.sendynl_processing_method) }}
                    {{ form_row(settingsFormView.sendynl_default_shop) }}
                    {{ form_row(settingsFormView.sendynl_import_products) }}
                    {{ form_row(settingsFormView.sendynl_import_weight) }}

                    <h4 class="mt-4 h2">{{ 'Statuses'|trans({}, 'Modules.Sendynl.Admin') }}</h4>
                    {{ form_row(settingsFormView.sendynl_processable_status) }}
                    {{ form_row(settingsFormView.sendynl_status_generated) }}
                    {{ form_row(settingsFormView.sendynl_status_printed) }}
                    {{ form_row(settingsFormView.sendynl_status_delivered) }}
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-end">
                    <button class="btn btn-primary float-right" id="save-button">
                        {{ 'Save'|trans({}, 'Admin.Actions') }}
                    </button>
                </div>
            </div>
        </div>
        {{ form_end(settingsFormView) }}

        {% embed '@PrestaShop/Admin/Common/Grid/grid_panel.html.twig' with {'grid': carrierGrid} %}
            {% block grid_actions_block %}
                <div class="d-inline-block float-right">
                    <a href="{{ path('admin_carriers_index') }}" class="btn btn-sm btn-outline-secondary">
                        {{ 'View all carriers'|trans({}, 'Modules.Sendynl.Admin') }}
                    </a>
                    <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#sendynlCreateCarrierModal">
                        <i class="material-icons">add_circle_outline</i>
                        {{ 'Add new carrier'|trans({}, 'Admin.Shipping.Feature') }}
                    </button>
                </div>
            {% endblock %}
        {% endembed %}
    {% endif %}

    {% include '@Modules/sendynl/views/templates/admin/carrier_modal.html.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // Show/hide form fields based on the value of other fields
        document.addEventListener('DOMContentLoaded', function () {
            const conditionalElements = document.querySelectorAll('[data-conditional]');

            function updateConditionalVisibility() {
                conditionalElements.forEach(el => {
                    const condition = el.dataset.conditional;
                    const [fieldName, expectedValue] = condition.split('=');

                    const controller = document.querySelector(`[name$="[${fieldName}]"]`);
                    if (!controller) return;

                    const shouldShow = controller.value === expectedValue;
                    const wrapper = el.closest('.form-group.row');

                    if (wrapper) {
                        wrapper.style.display = shouldShow ? '' : 'none';
                    }
                });
            }

            const watchedFields = new Set();
            conditionalElements.forEach(el => {
                const [fieldName] = el.dataset.conditional.split('=');
                if (watchedFields.has(fieldName)) return;

                watchedFields.add(fieldName);
                const input = document.querySelector(`[name$="[${fieldName}]"]`);
                if (input) {
                    input.addEventListener('change', updateConditionalVisibility);
                }
            });

            updateConditionalVisibility();
        });

        $(() => {

            // initialize choice column for carrier grid
            const carrierGrid = new window.prestashop.component.Grid('sendynl_carrier');
            carrierGrid.addExtension(new window.prestashop.component.GridExtensions.ChoiceExtension());

        })
    </script>
{% endblock %}
